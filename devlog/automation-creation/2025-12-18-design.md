# WP-4.2: Simple Automation Creation - Design Document

**Date:** 2025-12-18
**Status:** In Progress
**Owner:** Agent-Worker-4821

## Overview

This document outlines the design for natural language automation creation. Users should be able to create automations via voice/text like:
- "Turn on warm yellow lights at 8pm"
- "Start vacuum when I leave"

## Requirements (from REQ-022)

- [ ] "Do X at time Y" automations (time-based triggers)
- [ ] "When X happens, do Y" automations (event-based triggers)
- [ ] Natural language input processed by LLM
- [ ] All automations visible in one central location
- [ ] Edit/delete automations easily
- [ ] Automations stored in user system (not scattered across apps)

## Architecture Decision: Dual-Backend Approach

After reviewing the codebase and Home Assistant capabilities, I propose a **dual-backend approach**:

### 1. Simple Time-Based Automations → Our SQLite Database
- **Trigger:** Time-based only (daily, weekly, specific times)
- **Action:** Agent commands (lights, vacuum, blinds, etc.)
- **Benefits:** Simple, immediate, no YAML complexity
- **Implementation:** Scheduler polls database, executes commands

### 2. Complex Event-Based Automations → Home Assistant Automations
- **Trigger:** Entity state changes, presence, etc.
- **Action:** HA services or our agent endpoint
- **Benefits:** Leverages HA's powerful trigger system
- **Implementation:** Generate HA automation YAML via API

## Data Model

### Table: `automations`

```sql
CREATE TABLE automations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    trigger_type TEXT NOT NULL,  -- 'time', 'state', 'presence'
    trigger_config TEXT NOT NULL,  -- JSON: time config or entity/state config
    action_type TEXT NOT NULL,  -- 'agent_command', 'ha_service'
    action_config TEXT NOT NULL,  -- JSON: command text or service call
    enabled BOOLEAN DEFAULT TRUE,
    ha_automation_id TEXT,  -- If synced to HA
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_triggered TIMESTAMP
);
```

### Trigger Config Examples

**Time Trigger:**
```json
{
    "type": "time",
    "time": "20:00",
    "days": ["mon", "tue", "wed", "thu", "fri", "sat", "sun"],
    "timezone": "America/New_York"
}
```

**State Trigger (for HA sync):**
```json
{
    "type": "state",
    "entity_id": "person.katherine",
    "from_state": "home",
    "to_state": "not_home"
}
```

### Action Config Examples

**Agent Command:**
```json
{
    "type": "agent_command",
    "command": "turn living room to warm yellow at 80% brightness"
}
```

**HA Service Call:**
```json
{
    "type": "ha_service",
    "domain": "light",
    "service": "turn_on",
    "service_data": {
        "entity_id": "light.living_room",
        "brightness_pct": 80,
        "color_temp_kelvin": 2700
    }
}
```

## Agent Tools

### 1. `create_automation`
Parse natural language into automation config.

**Input Schema:**
```json
{
    "description": "Natural language automation request",
    "properties": {
        "command": {
            "type": "string",
            "description": "What the user wants (e.g., 'turn on lights at 8pm daily')"
        }
    }
}
```

### 2. `list_automations`
Show all configured automations.

### 3. `update_automation`
Modify an existing automation.

### 4. `delete_automation`
Remove an automation.

### 5. `toggle_automation`
Enable/disable an automation.

## Scheduler Design

For time-based automations, we need a background scheduler:

```python
class AutomationScheduler:
    def __init__(self, automation_manager):
        self.manager = automation_manager
        self._running = False
        self._thread = None

    def start(self):
        # Run scheduler loop in background thread
        # Check every minute for due automations
        pass

    def _check_due_automations(self):
        # Get automations due now
        # Execute actions
        # Update last_triggered
        pass
```

**Integration:** Scheduler starts with server.py (similar to planned reminder notification worker).

## NL Parsing Strategy

The main agent (Claude) parses natural language into structured automation config:

1. **Input:** "Turn on warm yellow lights at 8pm every day"
2. **LLM extracts:**
   - Trigger: time-based, 20:00, daily
   - Action: lights, warm yellow color
3. **Output:** Structured automation config

This leverages the existing agent pattern - no new NL parsing code needed.

## UI Components

### API Endpoints
- `GET /api/automations` - List all
- `POST /api/automations` - Create new
- `PUT /api/automations/<id>` - Update
- `DELETE /api/automations/<id>` - Delete
- `POST /api/automations/<id>/toggle` - Enable/disable

### Web UI
- New tab or section in main interface
- List view with toggle switches
- Edit modal for modification
- Simple form for manual creation (alongside voice)

## Test Plan

### Unit Tests (15+)
1. AutomationManager initialization
2. Create automation (time-based)
3. Create automation (state-based)
4. Get automation by ID
5. List automations (all)
6. List automations (enabled only)
7. Update automation name/description
8. Update automation trigger config
9. Update automation action config
10. Delete automation
11. Toggle automation enable/disable
12. Validate trigger config (time)
13. Validate trigger config (state)
14. Parse time trigger string
15. Get due automations

### Integration Tests (10+)
1. Create automation via agent tool
2. List automations via agent tool
3. Delete automation via agent tool
4. NL parsing: time-based simple
5. NL parsing: time-based with days
6. NL parsing: state-based presence
7. Scheduler detects due automation
8. Scheduler executes agent command
9. API endpoint create/list
10. API endpoint delete

## Implementation Order

1. ✅ Design document (this)
2. Write unit tests for AutomationManager
3. Implement AutomationManager class
4. Write agent tools
5. Write integration tests
6. Implement scheduler (basic)
7. Add UI components

## Files to Create

- `src/automation_manager.py` - Core manager class
- `tools/automation.py` - Agent tool definitions
- `tests/unit/test_automation_manager.py` - Unit tests
- `tests/integration/test_automation.py` - Integration tests

## Dependencies

- `src/config.py` - DATA_DIR for database
- `src/ha_client.py` - For executing HA service calls
- `src/utils.py` - Logging setup
- `agent.py` - For executing agent commands
