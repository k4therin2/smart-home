# WP-11.6: Camera Query REST API

**Date:** 2026-01-03
**Author:** Agent-Anette
**Work Package:** WP-11.6: MCP Query API for Cross-System Access

## Summary

Implemented REST API endpoints for querying camera observation data from external systems. This enables the agent-automation system, trading bot, and other internal services to query camera events without direct database access.

## Implementation

### API Endpoints

Added two endpoints to `src/server.py`:

1. **GET /api/camera/events** - Query camera events with filters
   - Parameters: object, camera, time_range, limit
   - Rate limit: 60/min

2. **GET /api/camera/summary** - Get activity summary
   - Parameters: time_range, camera
   - Rate limit: 30/min

### Authentication

Implemented two authentication methods:

1. **Tailscale IP Auto-Auth** - Requests from 100.x.x.x are automatically trusted
2. **API Key** - X-API-Key header for non-Tailscale access

Authentication is verified by `verify_camera_api_auth()` which checks both methods.

### Key Design Decisions

1. **Reused existing infrastructure** - Leverages `parse_time_range()` from WP-11.5's camera_query.py
2. **Tailscale-first auth** - Internal systems don't need API keys
3. **Rate limiting** - Prevents abuse while allowing reasonable query volume
4. **Partial camera matching** - Camera filter uses partial string match for convenience

## Files Changed

- `src/server.py` - Added camera API endpoints (~270 lines)
- `tests/api/test_camera_api.py` - 24 integration tests (new file)
- `docs/camera-api.md` - API documentation (new file)
- `plans/roadmap.md` - Marked WP-11.6 complete

## Test Coverage

24 tests covering:
- Endpoint functionality (basic access, JSON responses)
- Query parameter parsing (object, camera, time_range, limit)
- Authentication (Tailscale IP, API key, rejection)
- Error handling (invalid params, database errors)
- Response format validation

All tests pass:
```
tests/api/test_camera_api.py - 24 passed in 0.80s
```

## Example Usage

```bash
# From Tailscale network (no auth needed)
curl "http://colby:5049/api/camera/events?object=cat&time_range=today"

# From external with API key
curl -H "X-API-Key: your-key" "http://colby:5050/api/camera/events"
```

## Related Work

- WP-11.5: Voice Query Support (provides parse_time_range)
- WP-11.2: Camera Storage System (provides CameraObservationStore)

## Future Enhancements

- Camera filter could be enhanced to match camera IDs directly instead of post-filtering
- Could add pagination support for large result sets
- Could add WebSocket subscription for real-time camera events
