# WP-11.5: Voice Query Support for Camera Observations

**Date:** 2026-01-03
**Agent:** Anette
**Work Package:** WP-11.5
**Project:** SmartHome - Phase 11 (Camera Vision Intelligence)

## Summary

Implemented natural language voice queries for camera observations, enabling users to ask questions like "what has the cat been up to today" and receive spoken summaries of camera activity.

## What Was Built

### New Module: `tools/camera_query.py`

A comprehensive query tool for camera observations with:

1. **Time Range Parsing** (`parse_time_range()`)
   - Handles: today, yesterday, this morning, this afternoon, this evening
   - Handles: last hour, last N hours, this week
   - Handles: specific dates ("on December 25th")
   - Smart defaults: "this afternoon" returns yesterday afternoon if it's still morning

2. **Object Type Normalization** (`normalize_object_type()`)
   - Maps synonyms: kitty/kitten → cat, puppy/doggy → dog
   - Named pet recognition: "Sophie" → dog
   - Package variants: delivery/parcel/amazon → package
   - Person queries: someone/anyone/visitor → person

3. **Query Parsing** (`parse_camera_query()`)
   - Extracts object type, time range, and camera location from natural language
   - Handles "who" questions (implies person)
   - Detects camera locations from query context

4. **Summary Generation** (`generate_activity_summary()`)
   - Creates natural, voice-friendly summaries
   - Includes observation counts, times, and locations
   - Formats timestamps as "2 hours ago" or "at 2pm"
   - Truncates long descriptions for TTS

5. **Voice Response Formatting** (`format_for_voice()`)
   - Limits response length for TTS (200 chars)
   - Ensures proper punctuation
   - Handles sentence-level truncation

### Example Queries

```
User: "what has the cat been up to today"
Response: "The cat was seen 2 times today. At 2 hours ago in the living room:
           A gray cat is sitting on the couch looking out the window."

User: "did I get any packages delivered"
Response: "I saw a package once today. At 3 hours ago at the front door:
           A delivery person is placing a package at the front door."

User: "when did Sophie go outside"
Response: "The dog was seen 2 times today in the backyard. At 4 hours ago:
           A brown dog named Sophie is running in the backyard chasing a ball."
```

### Integration with Agent

- Added `query_camera_activity` tool to `agent.py`
- Tool schema allows LLM to call with natural language query
- Returns voice-formatted response for TTS output

## Technical Details

### Dependencies
- WP-11.2: Camera Storage System (camera_store.py) - provides observation storage
- WP-11.4: LLaVA Integration (vision_llm_client.py) - provides LLM descriptions

### Test Coverage
- 51 unit tests covering:
  - Time range parsing (10 tests)
  - Object type normalization (5 tests)
  - Query parsing (6 tests)
  - Query execution (6 tests)
  - Summary generation (5 tests)
  - Voice formatting (4 tests)
  - Tool integration (4 tests)
  - End-to-end voice queries (6 tests)
  - Edge cases (5 tests)

### Files Changed
- `tools/camera_query.py` (new, 450 lines)
- `tests/test_camera_voice_query.py` (new, 490 lines)
- `agent.py` (modified, added tool integration)

## What Unblocked

**WP-11.6: MCP Query API for Cross-System Access** is now unblocked and ready for implementation.

## Acceptance Criteria Met

- [x] Voice queries work through existing agent
- [x] Time range parsing (today, yesterday, this morning, etc.)
- [x] Object filtering (cat, dog, person, package, etc.)
- [x] Summary generation from multiple events
- [x] Voice responses are natural and concise
- [x] 30+ unit tests (51 implemented)

## Next Steps

1. WP-11.6: MCP Query API for Cross-System Access
2. User testing of voice queries with real camera observations
3. Potential enhancements:
   - Camera location aliases ("front camera" → "camera.front_door")
   - Activity pattern detection ("is the cat more active than usual?")
   - Multi-object queries ("did anyone come near the packages?")
