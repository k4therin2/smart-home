# WP-10.11: Multi-User Support

**Date:** 2026-01-03
**Agent:** Agent-Nadia
**Status:** Complete

## Summary

Implemented multi-user support with three user roles (owner, resident, guest), guest access via password-protected URLs, per-user preferences, and command history tracking.

## Changes

### New Files
- `src/security/user_manager.py` - Multi-user management module
- `tests/unit/test_multi_user.py` - 36 comprehensive tests
- `docs/user-management.md` - User management documentation

### Features Implemented

1. **User Roles (REQ-008)**
   - Owner: Full control including user management
   - Resident: Most controls, can invite guests
   - Guest: Basic controls (lights, temperature, music)

2. **Guest Access**
   - Password-protected guest links
   - Configurable expiration (default: 4 hours)
   - Revokable access tokens
   - List active guest links

3. **User Preferences**
   - Save/get individual preferences
   - Get all preferences for a user
   - Upsert on conflict (update existing)

4. **Command History**
   - Log commands per user
   - Retrieve history newest-first
   - Configurable limit

5. **Permission System**
   - Role-based permissions
   - Permission checking for user objects
   - Support for GuestUser class

## Database Changes

Added to `auth.db`:
- `users.role` column (TEXT, default 'resident')
- `guest_links` table (token, name, password_hash, expires_at, revoked)
- `user_preferences` table (username, preference_key, preference_value)
- `user_history` table (username, command, result, timestamp)

## Testing

36 tests covering:
- User role enumeration and values
- Role hierarchy and permissions
- User profile creation and updates
- Guest link generation and validation
- Guest token expiration and revocation
- Guest session management
- Guest permission restrictions
- User preferences CRUD
- Command history logging
- Database schema creation
- Integration tests for complete flows

All tests pass.

## Acceptance Criteria (REQ-008)

- [x] Guest mode with basic controls (lights, temperature)
- [x] User profiles (owner, resident, guest)
- [x] Per-user preferences and history
- [x] Simple guest access via password-protected URL
- [x] Guest sessions expire after configurable time

## Notes

- Integration with existing auth.py via shared database
- Uses argon2 for password hashing (same as main auth)
- GuestUser class extends UserMixin for Flask-Login compatibility
- Permission checking works with both User and GuestUser objects
